# Important Notes from Zero 2 Prod Book

---

## Inner Development Loop

---

- `cargo watch -x run` : This command will watch for changes in the code and automatically re-run the application whenever a change is detected. This allows for a faster development cycle, as you don't have to manually stop and start the application every time you make a change.
- **Command Chaining**: You can chain multiple commands together like

```sh
cargo watch -x check -x test -x run
```

This will run `cargo check`, `cargo test`, and `cargo run` in sequence whenever a change is detected. This is useful for ensuring that your code compiles and passes tests before running the application. Our inner development loop right here.

---

## Code Coverage with `cargo-llvm-cov`

---

`cargo-llvm-cov` is a tool that provides code coverage information for Rust projects. It uses LLVM's coverage instrumentation to generate reports on which lines of code were executed during tests.
To use `cargo-llvm-cov`, you can install it using Cargo:

```sh
rustup component add llvm-tools-preview
cargo install cargo-llvm-cov
```

---

## Security Vulnerabilities check with `cargo-audit`

---

`cargo-audit` is a tool that checks for security vulnerabilities in Rust dependencies. It uses the RustSec Advisory Database to identify known vulnerabilities in the crates you are using.
To use `cargo-audit`, you can install it using Cargo:

```sh
cargo install cargo-audit
```

Once installed, you can run it in your project directory to check for vulnerabilities:

```sh
cargo audit
```

This will scan your `Cargo.toml` and `Cargo.lock` files for dependencies and report any known vulnerabilities, along with their severity and any available fixes.

---

## Project Scope

---

We will fulfill two user stories in this project:

- As a blog visitor,
  I want to subscribe to the newsletter,
  So that I can receive email updates when new content is published on the blog.

- As the blog author,
  I want to send an email to all my subscribers,
  So that I can notify them when new content is published on the blog.

We will not add features to

- unsubscribe from the newsletter;
- manage multiple newsletters;
- segment subscribers in multiple audiences;
- track opening and click rates of the emails;

---

## Seeing macros in action with `cargo expand`

---

`cargo expand` is a tool that allows you to see the expanded code generated by Rust macros. This is particularly useful for understanding how macros work and for debugging macro-related issues.
To use `cargo expand`, you can install it using Cargo:

```sh
cargo install cargo-expand
```

You can then run it in your project directory to see the expanded code for a specific item:

```sh
cargo expand --lib
```

---

## Using SQLx with `sqlx-cli`

---

### Installing `sqlx-cli`

`sqlx-cli` is a command-line tool for working with SQLx, a Rust library for interacting with databases. It provides features like database migrations and query validation.
To install `sqlx-cli` for postgres, you can use Cargo:

```sh
cargo install --version='~0.8' sqlx-cli --no-default-features --features rustls,postgres
```

### Setting up the database

First set the environment variable `DATABASE_URL` to point to your Postgres database. For example:

```sh
export DATABASE_URL=postgres://username:password@localhost/database_name
```

Then you can create the database using the following command:

```sh
sqlx database create
```

### Running Migrations

To create a new migration, you can use the following command:

```sh
sqlx migrate add create_subscriptions_table
```

This will create a new migration file in the `migrations` directory. You can then edit this file to define the SQL commands needed to create the `subscriptions` table.

Then you can run the migrations to apply them to the database:

```sh
sqlx migrate run
```

This will execute the SQL commands in the migration files and create the necessary tables in your database.

---

## Bunyan

---

You can use 'bunyan' CLI to prettify the outputted logs. Original requires NPM but you can install a rust-port with

```sh
cargo install bunyan
```

Then you can use it like this:

```sh
cargo run | bunyan
```

or

```sh
TEST_LOG=true cargo test health_check_works | bunyan
```

---

## Docker

---

### Building docker image from Dockerfile

```sh
docker build -t zero2prod .
```

This command builds a Docker image from the Dockerfile in the current directory and tags it as `zero2prod`.

### Need to cache sql query for sqlx compilation to happen before the code is compiled. This is done by running the following command

```sh
cargo sqlx prepare --workspace --check -- --all-targets
```

This command prepares the SQL queries for SQLx by checking them against the database schema. It ensures that all queries are valid and can be executed successfully. This step is necessary before compiling the code, as it allows SQLx to generate the necessary code for interacting with the database.

- `--workspace` : This flag tells Cargo to prepare SQL queries for all packages in the workspace.
- `--check` : This flag tells Cargo to check the SQL queries against the database schema without actually executing them. This is useful for catching any errors in the queries before running the application.
- `-- --all-targets` : This part tells Cargo to prepare SQL queries for all targets (e.g., library, binary, tests) in the workspace. The `--` is used to separate Cargo's own flags from the flags that are passed to the underlying command.

### Running our docker container

#### With port 8000 exposed

```sh
docker run -p 8000:8000 zero2prod
```

---

## Digital Ocean

---

Digital Ocean is a cloud infrastructure provider that offers various services, including virtual machines (droplets), managed databases, and Kubernetes clusters. It provides an easy-to-use interface for deploying and managing applications in the cloud.

### Installing `doctl` CLI

```sh
sudo snap install doctl
```

### Authenticating `doctl`

```sh
doctl auth init --context <name>
```

This command initializes the authentication process for `doctl` and creates a new context with the specified name. You will be prompted to enter your Digital Ocean API token, which can be obtained from the Digital Ocean control panel.

- `--context <name>` : This flag specifies the name of the context to create. A context is a named set of credentials and configuration that allows you to manage multiple Digital Ocean accounts or projects from a single `doctl` installation.

You can switch between contexts using the following command:

```sh
doctl auth switch --context <name>
```

You can see all available contexts with:

```sh
doctl auth list
```

### Creating an app using CLI

You can create a new app on Digital Ocean using the following command:

```sh
doctl apps create --spec app_spec.yaml
```

### Checking your app status

```sh
doctl apps list
```

Or on dashboard.

### Viewing URI after deployment is confirmed

```sh
doctl apps list
```

### Adding database to your app

After updating your `spec.yaml` file to include a database, you can create the app with the following command:

```sh
doctl apps update <your-app-id> --spec=app_spec.yaml
```

`<your-app-id>` can be obtained from the output of `doctl apps list` command.

### Deleting your app

```sh
doctl apps delete <your-app-id>
```
